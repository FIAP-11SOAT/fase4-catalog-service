name: Deploy to AWS

on:
  push:
    branches:
      - main
      - feat/feature-catalog
  workflow_dispatch:

permissions:
  id-token: write   # required for OIDC
  contents: read    # checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: fase4-catalog-service
      AWS_REGION: us-east-1
      TF_GH_OWNER: FIAP-11SOAT
      TF_GH_REPO: fase4-catalog-service
      TF_GH_BRANCH: feat/feature-catalog
      ARTIFACT_KEY: releases/${{ github.sha }}.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: acct
        shell: bash
        run: echo "account=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Build Lambda package
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.app.txt -t build
          mkdir -p build/app
          cp -R app/* build/app/
          cd build
          zip -r ../package.zip .

      - name: Compute artifacts bucket name
        id: bucket
        shell: bash
        run: |
          NAME=$(echo "${PROJECT_NAME}" | tr '_' '-' | tr '[:upper:]' '[:lower:]')
          echo "bucket=${NAME}-${{ steps.acct.outputs.account }}-${AWS_REGION}-artifacts" >> $GITHUB_OUTPUT

      - name: Upload artifact to S3
        id: upload
        shell: bash
        run: |
          VERSION_ID=$(aws s3api put-object --bucket "${{ steps.bucket.outputs.bucket }}" --key "${ARTIFACT_KEY}" --body package.zip --query 'VersionId' --output text)
          echo "version=${VERSION_ID}" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: infra
        shell: bash
        run: terraform init -input=false

      - name: Terraform Apply
        working-directory: infra
        shell: bash
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_artifact_key: ${{ env.ARTIFACT_KEY }}
          TF_VAR_artifact_object_version: ${{ steps.upload.outputs.version }}
          TF_VAR_gh_owner: ${{ env.TF_GH_OWNER }}
          TF_VAR_gh_repo: ${{ env.TF_GH_REPO }}
          TF_VAR_gh_branch: ${{ env.TF_GH_BRANCH }}
        run: terraform apply -auto-approve -input=false
name: Deploy (Terraform + AWS Lambda - Zip)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  id-token: write   # OIDC para assumir role na AWS (recomendado)
  contents: read

env:
  AWS_REGION: us-east-1
  TF_WORKING_DIR: infra
  PROJECT_NAME: fase4-catalog-service

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # Alternativa com chaves long-lived (nÃ£o recomendado):
      # - name: Configure AWS credentials (keys)
      #   if: ${{ !secrets.AWS_ROLE_TO_ASSUME }}
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Terraform Init
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} init

      - name: Terraform Apply (create/ensure artifacts bucket)
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} apply -auto-approve -target=aws_s3_bucket.artifacts -target=aws_s3_bucket_versioning.artifacts

      - name: Get artifacts bucket name (tf output)
        id: tfout
        run: |
          echo "ARTIFACTS_BUCKET=$(terraform -chdir=${{ env.TF_WORKING_DIR }} output -raw artifacts_bucket)" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Ensure zip is installed
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Build Lambda artifact (.zip)
        run: |
          set -e
          python -m pip install --upgrade pip
          mkdir -p package
          pip install -r requirements.app.txt -t package
          cp -R app package/
          if [ -d migrations ]; then cp -R migrations package/; fi
          cd package
          zip -r ../artifact.zip .
          cd ..
          sha256sum artifact.zip > artifact.sha256

      - name: Upload artifact to S3
        env:
          BUCKET: ${{ steps.tfout.outputs.ARTIFACTS_BUCKET }}
          KEY: releases/${{ github.sha }}.zip
        run: |
          aws s3 cp artifact.zip s3://${BUCKET}/${KEY}
          VERSION=$(aws s3api head-object --bucket ${BUCKET} --key ${KEY} --query VersionId --output text)
          echo "ARTIFACT_KEY=${KEY}" >> $GITHUB_ENV
          echo "ARTIFACT_VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Terraform Apply (deploy Lambda + API)
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          PROJECT_NAME: ${{ env.PROJECT_NAME }}
          ARTIFACT_KEY: ${{ env.ARTIFACT_KEY }}
          ARTIFACT_VERSION: ${{ env.ARTIFACT_VERSION }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          VPC_SUBNET_IDS_CSV: ${{ secrets.VPC_SUBNET_IDS_CSV }}
          VPC_SECURITY_GROUP_IDS_CSV: ${{ secrets.VPC_SECURITY_GROUP_IDS_CSV }}
        run: |
          terraform -chdir=${TF_WORKING_DIR} apply \
            -auto-approve \
            -var="aws_region=${AWS_REGION}" \
            -var="project_name=${PROJECT_NAME}" \
            -var="artifact_key=${ARTIFACT_KEY}" \
            -var="artifact_object_version=${ARTIFACT_VERSION}" \
            -var="db_host=${DB_HOST}" \
            -var="db_port=${DB_PORT}" \
            -var="db_name=${DB_NAME}" \
            -var="db_user=${DB_USER}" \
            -var="db_pass=${DB_PASS}" \
            -var="vpc_subnet_ids_csv=${VPC_SUBNET_IDS_CSV}" \
            -var="vpc_security_group_ids_csv=${VPC_SECURITY_GROUP_IDS_CSV}"

      - name: Show API URL
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} output api_url
